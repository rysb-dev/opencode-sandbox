# =============================================================================
# Squid Proxy Configuration for OpenCode Sandbox
# =============================================================================
# This configuration creates a restrictive proxy that only allows connections
# to explicitly whitelisted domains. All other traffic is denied.
#
# Supports optional upstream (corporate) proxy via environment variables:
#   UPSTREAM_PROXY_HOST - Upstream proxy hostname
#   UPSTREAM_PROXY_PORT - Upstream proxy port (default: 3128)
# =============================================================================

# -----------------------------------------------------------------------------
# Basic Settings
# -----------------------------------------------------------------------------

# Listen on port 3128 for HTTP proxy connections
http_port 3128

# Disable caching (we're using squid for filtering, not caching)
cache deny all

# Run as proxy user (required - squid won't run as root)
cache_effective_user proxy
cache_effective_group proxy

# Log access to stdout for Docker (using syslog format which doesn't need file perms)
access_log none
cache_log none

# Process settings
pid_filename none
coredump_dir /var/spool/squid

# Reduce shutdown time
shutdown_lifetime 1 seconds

# -----------------------------------------------------------------------------
# Upstream (Parent) Proxy Configuration
# -----------------------------------------------------------------------------
# If /etc/squid/upstream_proxy.conf exists, include it.
# This file is generated at container startup if UPSTREAM_PROXY_HOST is set.
# It contains cache_peer and never_direct directives.
include /etc/squid/upstream_proxy.conf

# -----------------------------------------------------------------------------
# Access Control Lists (ACLs)
# -----------------------------------------------------------------------------

# Ports that CONNECT method is allowed to use
acl SSL_ports port 443
acl SSL_ports port 22   # SSH for git

# Safe ports for regular HTTP
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 22          # SSH for git
acl Safe_ports port 1025-65535  # unregistered ports (for various APIs)

# CONNECT method (used for HTTPS)
acl CONNECT method CONNECT

# Load allowed domains from external file
# This file contains one domain per line (with leading dot for subdomains)
acl allowed_domains dstdomain "/etc/squid/allowed_domains.txt"

# -----------------------------------------------------------------------------
# Access Rules
# -----------------------------------------------------------------------------

# Deny requests to unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow connections to whitelisted domains only
http_access allow allowed_domains

# Deny everything else
http_access deny all

# -----------------------------------------------------------------------------
# Privacy Settings
# -----------------------------------------------------------------------------

# Don't forward client IP in headers
forwarded_for off

# Disable via header
via off

# Minimal request headers forwarded
request_header_access Allow allow all
request_header_access Authorization allow all
request_header_access Content-Encoding allow all
request_header_access Content-Length allow all
request_header_access Content-Type allow all
request_header_access Host allow all
request_header_access User-Agent allow all
request_header_access Accept allow all
request_header_access Accept-Encoding allow all
request_header_access Accept-Language allow all
request_header_access Connection allow all
request_header_access All deny all
